---
slug: data-hash-security
title: 主键、哈希的安全性
type:  docs
sidebar_position: 4
---

    
## 主键的 碰撞安全性 和 冲突安全性
### 1. 安全风险：碰撞安全性
- 假设doptime-client允许 hget("userInfoPublic",otherUserId)来查询用户信息。
- 有入侵者，随机生成了大量 otherUserId，通过暴力碰撞，扫描用户信息。 
- 这种非预期查询，就是碰撞安全性

### 2. 安全风险：冲突安全性
- 设想我们采用用户名的哈希值作为主键来修改和查看用户信息。  
- 但不幸的是，两个用户的用户名哈希值有可能恰巧相同。   
- 这种情况下，用户A修改的信息会被B看到，B修改的信息会被A看到。他们似乎感觉信息被入侵篡改了 
- 这种并非期望的的哈希值相同，构成了冲突安全隐患
  

##  解决 主键、哈希 安全性  
### 足够长的主键
  解决 主键/哈希 的 碰撞安全性 和 冲突安全性冲突也简单：只需确保主键足够长。  
  也许你很聪明，有别的方法来解决哈希值的安全风险。[但暴力方案总是最优，最彻底的解决方案](http://www.incompleteideas.net/IncIdeas/BitterLesson.html)。  
  代价是放弃人类的简洁强迫心理。  

### 多长的主键、哈希才能确保碰撞安全性
一般来说，64位的主键够用了。 64位的主键长度的可以应付本机+批量碰撞测试。

 
### 多长的主键、哈希才能确保冲突安全性  
一般来说，64位的主键够用了。 如果你是头部互联网公司，那么96位的objectID可能是有必要的。
- 预期冲突数公司为：p(n) =1 - e^(-k*(k-1)/(2*n)).其中n是数据规模，k是key的位长。
- 无论你的数据规模如何，都不建议使用int32作为主键。建议使用int64或者是string类型。  
- 为了使32位哈希时预期冲突数为1，数据规模要小于大约92682 (16Bit)。  
- 为了使64位哈希时预期冲突数为1，数据规模要小于大约60.74亿 (32Bit)。  
- 为了使96位哈希时预期冲突数为1(mongodb 的objectid)，数据规模要小于大约398T.(48bit)   


## 主键的类型 和生成方式
### 类型 - 建议使用string类型
- 不建议redis 主键使用int类型，像是int32、int64。
- int类型在js中可能会意外地被表示位float64。当它们转换成为string时，可能会出现被表示成科学计数法的情况，造成无法读取数据。
### 生成方式 建议 使用 xxhash
- doptime 最佳实践。建议使用xxhash.XXH64(key)来生成hash。
- xxhash有方便的js库，可以直接在客户端计算hash值。许多时候这样是方便的。
